name: Sentry Upload (dSYM / sourcemaps)

on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Sentry release (e.g., my-app@1.2.3)'
        required: true
      dsym_path:
        description: 'Path or URL to dSYM zip or folder (optional)'
        required: false
      mapping_path:
        description: 'Path to Android mapping.txt (optional)'
        required: false
      sourcemaps_path:
        description: 'Path to JS sourcemaps directory or zip (optional)'
        required: false
  release:
    types: [published]

jobs:
  upload:
    runs-on: ubuntu-latest
    env:
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup sentry-cli
        uses: getsentry/action-setup-sentry-cli@v1

      - name: Make scripts executable
        run: |
          chmod +x ./scripts/upload-to-sentry.sh || true
          chmod +x ./scripts/upload-dsym.sh || true

      - name: Upload artifacts to Sentry
        run: |
          set -euo pipefail
          RELEASE="${{ github.event.inputs.release || github.ref_name }}"
          echo "Using release: $RELEASE"
          DSYM_PATH="${{ github.event.inputs.dsym_path }}"
          MAPPING_PATH="${{ github.event.inputs.mapping_path }}"
          SOURCEMAPS_PATH="${{ github.event.inputs.sourcemaps_path }}"

          if [ -n "$DSYM_PATH" ]; then
            echo "Uploading dSYMs from $DSYM_PATH"
            ./scripts/upload-to-sentry.sh --release "$RELEASE" --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" --dsym "$DSYM_PATH"
          fi

          if [ -n "$MAPPING_PATH" ]; then
            echo "Uploading mapping file from $MAPPING_PATH"
            ./scripts/upload-to-sentry.sh --release "$RELEASE" --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" --mapping "$MAPPING_PATH"
          fi

          if [ -n "$SOURCEMAPS_PATH" ]; then
            echo "Uploading sourcemaps from $SOURCEMAPS_PATH"
            ./scripts/upload-to-sentry.sh --release "$RELEASE" --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" --sourcemaps "$SOURCEMAPS_PATH"
          fi
        shell: bash
